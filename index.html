<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <title>Västtrafik reseplanerare</title>
  <script type="text/javascript" src="js/vendor/vue.js"></script>
</head>
<body>

  <div id="app">
    <h1>Sök resa (beta)</h1>
    <location-input label="Från" @set-location="setFrom"></location-input>
    <location-input label="Till" @set-location="setDest"></location-input>
    <button v-on:click="findTrip" :disabled="!from || !dest">Sök</button>
    <ol v-for="(trip, index) in trips">
      <li class="trip" v-for="leg in trip">
        {{ leg.Origin.rtTime || leg.Origin.time }} {{ leg.Origin.name }} Läge {{ leg.Origin.track }} - {{ leg.Destination.name }} ({{ leg.Destination.rtTime || leg.Destination.time }})
      </li>
    </ol>
  </div>

  <script src="js/vendor/moment.js"></script>
  <script src="js/vt.js"></script>
  <script src="js/script.js"></script>
  <script>
    Vue.component('location-input', {
      props: {
        label: String
      },
      data() {
        return {
          location: {},
          suggestions: []
        };
      },
      methods: {
        onInput(event) {
          VT.getLocationSuggestions(event.target.value)
            .then((stops) => this.suggestions = stops.slice(0, 5));
        },
        onSelect(suggestion) {
          this.location = suggestion;
          this.$emit('set-location', suggestion);
          this.suggestions = [];
        },
        selectFirstSuggestion() {
          if (this.suggestions.length === 0) return;
          this.onSelect(this.suggestions[0]);
        }
      },
      template: `
        <div class="location-input">
          <label>
            {{label}}: <input v-model="location.name" @input="onInput" @keyup.enter="selectFirstSuggestion" placeholder="Ange station">
          </label>
          <ul class="location-input__suggestions">
            <li v-for="suggestion in suggestions" :key="suggestion.id">
              <a href="#" @click.prevent="onSelect(suggestion)">{{ suggestion.name }}</a>
            </li>
          </ul>
        </div>`
    });

    new Vue({
      el: '#app',
      data: {
        from: null,
        dest: null,
        trips: []
      },
      methods: {
        setFrom(location) {
          this.from = location.id;
        },
        setDest(location) {
          this.dest = location.id;
        },
        findTrip() {
          VT.getTripSuggestion(this.from, this.dest)
            .then((trips) => {
              this.trips = trips;
              console.log(trips);
            });
        }
      }
    });
  </script>
</body>
</html>
