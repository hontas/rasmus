<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <meta name="theme-color" content="#8b0000">
  <link rel="manifest" href="manifest.json">
  <link rel="stylesheet" type="text/css" href="css/font-awesome.css">
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <link rel="shortcut icon" type="image/x-icon" href="favicon.ico" />
  <title>Resmus - Rasmus reseplanerare</title>

  <script type="text/x-template" id="search-trip">
    <div class="search-trip">
      <div class="form">
        <i v-if="!initialized" class="fa fa-spin fa-spinner"></i>
        <location-input displayNearbyStops locationApi="RR" label="Från" :parentLoading="isLoading" :disabled="!initialized" @set-location="setFrom"></location-input>
        <location-input locationApi="RR" label="Till" :parentLoading="isLoading" :disabled="!initialized" @set-location="setDest"></location-input>
        <button class="btn" @click="findTrip" :disabled="!from || !dest">
          Sök
          <i class="fa fa-spin" :class="{ 'fa-spinner': isLoading }" aria-hidden="true"></i>
        </button>
      </div>
      <trips-list :trips="trips"></trips-list>
    </div>
  </script>

  <script type="text/x-template" id="station-info">
    <div class="station-info">
      <div class="form">
        <i v-if="!initialized" class="fa fa-spin fa-spinner"></i>
        <location-input locationApi="VT" displayNearbyStops label="Från" :parentLoading="isLoading" :disabled="!initialized" @set-location="setFrom"></location-input>
      </div>
      <destination-board :trips="trips" :info="info" :from="location.name"></destination-board>
    </div>
  </script>

  <script type="text/x-template" id="location-input">
    <div class="location-input"
      :class="{ 'with-label': label }"
      @focus="showDropDown"
      @keyup.esc="hideDropDown">

      <label>
        {{label}}:
        <input v-model="searchText"
          @input="onInput"
          @focus="showDropDown"
          @blur="possiblyHideDropDown"
          @keyup.enter="selectFirstSuggestion"
          @keyup="handleKeyInput"
          type="search"
          placeholder="Hållplats"
          :disabled="disabled">
        <i class="fa fa-spin" :class="{ 'fa-spinner': isLoading }" aria-hidden="true"></i>
      </label>

      <ul v-show="show" class="location-input__suggestions">
        <li v-if="fetchingNearbyStops" @keyup="handleKeyInput">
          <a href="#" @click.prevent>
            Hämtar närliggande hållplatser
            <i class="fa fa-spinner fa-spin"></i>
          </a>
        </li>
        <li v-if="suggestions.length === 0 && !searchText" v-for="station in nearbyStations" @keyup="handleKeyInput">
          <a href="#" @click.prevent="onSelect(station)" @keyup.space="onSelect(station)">{{ station.name }}</a>
        </li>
        <li v-if="suggestions.length === 0 && searchText && !isFetching">
          <a href="#" @click.prevent>Inga resultat för söktermen</a>
        </li>
        <li v-for="suggestion in suggestions" :key="suggestion.id" @keyup="handleKeyInput">
          <a href="#" @click.prevent="onSelect(suggestion)" @keyup.space="onSelect(suggestion)">{{ suggestion.name }}</a>
        </li>
      </ul>
    </div>
  </script>
</head>
<body>

  <div id="app">
    <div class="top-nav">
      <ul class="tabs">
        <li class="tab" :class="{ active: (tab === 1) }" @click="changeTab(1)">Sök resa (resrobot)</li>
        <li class="tab" :class="{ active: (tab === 2) }" @click="changeTab(2)">Avgångar (västtrafik)</li>
      </ul>
      <digital-clock></digital-clock>
    </div>
    <div class="container">
      <search-trip v-if="tab === 1"></search-trip>
      <station-info v-if="tab === 2"></station-info>
    </div>
  </div>

  <!-- <ul class="trafik-info">
    <li>
      <div id="trafiken" class="trafiken-gbg">
        <h3></h3>
        <audio controls autoplay="true" />
      </div>
    </li>
    <li>
      <div id="trafiken" class="trafiken-sthlm">
        <h3></h3>
        <audio controls autoplay="true" />
      </div>
    </li>
  </ul> -->

  <script type="text/javascript" src="js/vendor/vue.js"></script>
  <script src="js/vendor/jquery-3.2.1.slim.min.js"></script>
  <script src="js/vendor/moment.js"></script>
  <!-- <script src="js/trafikMeddelanden.js"></script> -->
  <script src="js/vt.js"></script>
  <script src="js/sl.js"></script>
  <script src="js/tv.js"></script>
  <script src="js/resrobot.js"></script>
  <script>
const positionPromise = getPosition()
  .then(({ coords: { latitude: lat, longitude: long }}) => ({ lat, long }));

Vue.component('digital-clock', {
  data() {
    return {
      hours: '',
      minutes: '',
      seconds: '',
    };
  },
  created() {
    this.updateDateTime();
    setInterval(this.updateDateTime, 1000);
  },
  methods: {
    updateDateTime() {
      const now = new Date();
      this.hours = String(now.getHours()).padStart(2, "0");
      this.minutes = String(now.getMinutes()).padStart(2, "0");
      this.seconds = String(now.getSeconds()).padStart(2, "0");
    }
  },
  template: `
    <div class="digital-clock">
      {{ hours }}:{{ minutes }}:{{ seconds }}
    </div>
  `
});

Vue.component('destination-board', {
  props: {
    trips: Array,
    info: String,
    from: String
  },
  methods: {},
  template: `
    <table class="destination-board">
      <thead>
        <tr>
          <th>Linje</th>
          <th>Destination</th>
          <th>Tid</th>
          <th>Ny tid</th>
          <th>Hpl</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="trip in trips" :key="trip.id">
          <td class="trip-line" :style="{ backgroundColor: trip.fgColor, color: trip.bgColor }">
            {{ trip.sname }}
          </td>
          <td class="trip-dest">
            <div class="trip-dest-name">{{ trip.direction }}</div>
            <div class="trip-dest-via"><small v-if="trip.via"> via {{ trip.via }}</small></div>
          </td>
          <td class="trip-time">{{ trip.time }}</td>
          <td class="trip-time is-late"><span v-if="trip.isLate">{{ trip.rtTime }}</span></td>
          <td class="trip-track">{{ trip.track }}</td>
        </tr>
        <tr v-show="from && trips.length === 0">
          <td colspan="5">Inga resor att visa</td>
        </tr>
      </tbody>
      <tfoot v-if="from">
        <tr>
          <td colspan="5"><p>{{ info }}</p></td>
        </tr>
      </tfoot>
    </div>
  `
});

Vue.component('location-input', {
  props: {
    label: String,
    disabled: Boolean,
    parentLoading: Boolean,
    displayNearbyStops: {
      type: Boolean,
      default: false
    },
    locationApi: {
      type: String,
      validator(value) {
        return Object.prototype.hasOwnProperty.call(window[value], 'findStops') &&
          Object.prototype.hasOwnProperty.call(window[value], 'getClosestStop') &&
          Object.prototype.hasOwnProperty.call(window[value], 'getClosestStops') &&
          typeof window[value].findStops === 'function' &&
          typeof window[value].getClosestStop === 'function' &&
          typeof window[value].getClosestStops === 'function';
      }
    }
  },
  data() {
    return {
      show: false,
      isFetching: false,
      fetchingNearbyStops: this.displayNearbyStops,
      searchText: '',
      suggestions: [],
      nearbyStations: []
    };
  },
  computed: {
    isLoading() {
      return this.isFetching || this.parentLoading;
    },
    hasSuggestions() {
      return this.suggestions.length || this.nearbyStations.length;
    }
  },
  created() {
    this.debouncedGetSuggestions = debounce(this.getSuggestions, 350, this);
    if (!this.displayNearbyStops) return;
    positionPromise
      .then(window[this.locationApi].getClosestStops)
      .then((stations) => {
        this.nearbyStations = stations;
        this.fetchingNearbyStops = false;
      });
  },
  methods: {
    onInput({ target: { value } }) {
      if (!value) {
        this.suggestions = [];
      } else {
        this.isFetching = true;
        this.debouncedGetSuggestions(value);
      }
    },
    getSuggestions(value) {
      return window[this.locationApi].findStops(value)
        .then((stops) => {
          this.isFetching = false;
          this.suggestions = [].concat(stops);
          this.showDropDown();
        });
    },
    findNearestStop() {
      this.isFetching = true;
      Promise.resolve(positionPromise)
        .then(window[this.locationApi].getClosestStop)
        .then((location) => {
          if (location) this.onSelect(location);
          this.show = false;
          this.isFetching = false;
          this.isLoading = false;
        });
    },
    onSelect(suggestion) {
      this.searchText = suggestion.name;
      this.$emit('set-location', suggestion);
      this.hideDropDown();
      this.getSuggestions(suggestion.name)
        .then(this.hideDropDown);
    },
    selectFirstSuggestion() {
      if (this.suggestions.length === 0) return;
      this.onSelect(this.suggestions[0]);
    },
    handleKeyInput(e) {
      const dict = {
        ArrowUp: 'previousElementSibling',
        ArrowDown: 'nextElementSibling'
      };

      const getSibling = (el) => el.parentElement[dict[e.key]];

      if (['ArrowDown', 'ArrowUp'].includes(e.key) && this.show && this.hasSuggestions) {
        const focused = this.$el.querySelector('.location-input__suggestions a:focus');
        if (!focused) return this.$el.querySelector('.location-input__suggestions a').focus();
        const next = getSibling(focused);
        if (!next) return;
        next.querySelector('a').focus();
      }
    },
    showDropDown() {
      this.show = true;
    },
    hideDropDown() {
      this.show = false;
      document.activeElement.blur();
    },
    possiblyHideDropDown(e) {
      if (e.relatedTarget && this.$el.contains(e.relatedTarget)) return;
      this.hideDropDown();
    }
  },
  template: '#location-input'
});

Vue.component('trips-list', {
  props: {
    trips: Array
  },
  template: `
    <ul class="trips" v-if="trips.length">
      <li v-for="trip in trips">
        <trips-item :trip="trip">
      </li>
    </ul>
  `
});

Vue.component('trips-item', {
  props: {
    trip: Object
  },
  methods: {
    isLast(index, trip) {
      return index === trip.length - 1;
    }
  },
  template: `
    <article class="trip">
      <header>
        <h1>{{ trip.departs }} » {{ trip.arrives }}</h1>
        <p class="trip__duration">Restid {{ trip.duration }}</p>
      </header>
      <main>
        <ul class="trip__short-legs">
          <li class="trip__short-leg" v-for="leg in trip.legs">
            <span :class="leg.type"></span>
          </li>
        </ul>
        <p>{{ trip.legs.length - 1 }} byte</p>
      </main>
      <div class="trip__details" v-show="display-details">
        <ul class="trip__legs">
          <li class="trip__leg" :class="leg.type" v-for="(leg, index) in trip.legs">
            {{ leg.text }} <br/>
            <span class="trip__dest" v-if="isLast(index, trip)">
              ⇥ {{ leg.to.time }}
            </span>
          </li>
        </ul>
      </div>
    </article>
  `
});

Vue.component('search-trip', {
  template: '#search-trip',
  data() {
    return {
      from: null,
      dest: null,
      isLoading: false,
      trips: [],
      initialized: false
    };
  },
  created() {
    VT.init()
      .then(() => {
        this.initialized = true;
      });
  },
  methods: {
    setFrom(location) {
      this.from = location.id;
    },
    setDest(location) {
      this.dest = location.id;
      if (this.from) this.findTrip();
    },
    findTrip() {
      this.isLoading = true;
      RR.getTripSuggestion(this.from, this.dest)
        .then((trips) => {
          this.trips = trips;
          this.isLoading = false;
        });
    }
  }
});

Vue.component('station-info', {
  template: '#station-info',
  data() {
    return {
      location: {},
      isLoading: false,
      initialized: false,
      trips: [],
      info: ''
    };
  },
  computed: {
    show() {
      return !!this.trips.length;
    }
  },
  created() {
    VT.init()
      .then(() => {
        this.initialized = true;
      });
  },
  methods: {
    setFrom(location) {
      console.log('set location', location);
      this.location = location || {};
      this.isLoading = true;
      this.getDepartures();

      // refresh list every 20 seconds
      if (this.lastIntervalId) {
        clearInterval(this.lastIntervalId);
      }
      this.lastIntervalId = setInterval(this.getDepartures, 20000);
    },
    getDepartures() {
      window[this.location.region].getTrafficSituations('stoparea', this.location.id)
        .then((situations) => {
          console.log('situations', situations);
          this.info = situations;
        });
      window[this.location.region].getDeparturesFrom(this.location.id)
        .then((resp) => {
          this.trips = resp.map(getDestinationVia);
          console.log('this.trips', this.trips);
          this.isLoading = false;
        });
    }
  }
});

const viaRegExp = /\s*via\s*/;
function getDestinationVia(departure) {
  if (viaRegExp.test(departure.direction)) {
    const [direction, via] = departure.direction.split(viaRegExp);
    return Object.assign({}, departure, {
      direction,
      via
    });
  }
  return departure;
}

new Vue({
  el: '#app',
  data: { tab: 1 },
  methods: {
    changeTab(tab) {
      this.tab = tab;
    }
  }
});

function debounce(fn, delay, context) {
  let timeoutId;
  context = context || this;
  return (...args) => {
    if (timeoutId) clearTimeout(timeoutId);
    timeoutId = setTimeout(() => fn.apply(context, args), delay);
  };
}

function getPosition() {
  return new Promise((resolve, reject) => {
    if (!('geolocation' in navigator)) return reject();

    navigator.geolocation.getCurrentPosition(resolve);
  });
}
</script>
  <script>
if ('serviceWorker' in navigator && location.hostname !== 'localhost') {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then((registration) => {
        console.log('ServiceWorker registration successful with scope: ', registration.scope);
      }, (err) => {
        console.log('ServiceWorker registration failed: ', err);
      });
  });
}
  </script>
</body>
</html>
