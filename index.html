<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" type="text/css" href="css/font-awesome.css">
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <title>Västtrafik reseplanerare</title>
  <script type="text/javascript" src="js/vendor/vue.js"></script>

  <script type="text/x-template" id="search-trip">
    <div class="search-trip">
      <div class="form">
        <i class="fa" :class="{ 'fa-spin':  !initialized, 'fa-spinner': !initialized }"></i>
        <location-input displayNearbyStops locationApi="RR" label="Från" :parentLoading="isLoading" :disabled="!initialized" @set-location="setFrom"></location-input>
        <location-input locationApi="RR" label="Till" :parentLoading="isLoading" :disabled="!initialized" @set-location="setDest"></location-input>
        <button class="btn" @click="findTrip" :disabled="!from || !dest">
          Sök
          <i class="fa fa-spin" :class="{ 'fa-spinner': isLoading }" aria-hidden="true"></i>
        </button>
      </div>
      <trips-list :trips="trips"></trips-list>
    </div>
  </script>

  <script type="text/x-template" id="station-info">
    <div class="station-info">
      <div class="form">
        <i class="fa" :class="{ 'fa-spin':  !initialized, 'fa-spinner': !initialized }"></i>
        <location-input locationApi="TV" displayNearbyStops label="Från" :parentLoading="isLoading" :disabled="!initialized" @set-location="setFrom"></location-input>
      </div>
      <destination-board :trips="trips"></destination-board>
    </div>
  </script>

  <script type="text/x-template" id="location-input">
    <div class="location-input"
      :class="{ 'with-label': label }"
      @focus="showDropDown"
      @keyup.esc="hideDropDown">

      <label>
        {{label}}:
        <input v-model="searchText"
          @input="onInput"
          @focus="showDropDown"
          @blur="possiblyHideDropDown"
          @keyup.enter="selectFirstSuggestion"
          @keyup="handleKeyInput"
          type="search"
          placeholder="Ange station"
          :disabled="disabled">
        <i class="fa fa-spin" :class="{ 'fa-spinner': isLoading }" aria-hidden="true"></i>
      </label>

      <ul v-show="show" class="location-input__suggestions">
        <li v-if="fetchingNearbyStops" @keyup="handleKeyInput">
          <a href="#" @click.prevent>
            Hämtar närliggande hållplatser
            <i class="fa fa-spinner fa-spin"></i>
          </a>
        </li>
        <li v-if="suggestions.length === 0 && !searchText" v-for="station in nearbyStations" @keyup="handleKeyInput">
          <a href="#" @click.prevent="onSelect(station)" @keyup.space="onSelect(station)">{{ station.name }}</a>
        </li>
        <li v-if="suggestions.length === 0 && searchText && !isFetching">
          <a href="#" @click.prevent>Inga resultat för söktermen</a>
        </li>
        <li v-for="suggestion in suggestions" :key="suggestion.id" @keyup="handleKeyInput">
          <a href="#" @click.prevent="onSelect(suggestion)" @keyup.space="onSelect(suggestion)">{{ suggestion.name }}</a>
        </li>
      </ul>
    </div>
  </script>
</head>
<body>

  <div id="app">
    <div class="top-nav">
      <ul class="tabs">
        <li class="tab" :class="{ active: (tab === 1) }" @click="changeTab(1)">Sök resa</li>
        <li class="tab" :class="{ active: (tab === 2) }" @click="changeTab(2)">Visa avgångar (trafikverket)</li>
      </ul>
      <digital-clock></digital-clock>
    </div>
    <div class="container">
      <search-trip v-if="tab === 1"></search-trip>
      <station-info v-if="tab === 2"></station-info>
    </div>
  </div>

  <!-- <ul class="trafik-info">
    <li>
      <div id="trafiken" class="trafiken-gbg">
        <h3></h3>
        <audio controls autoplay="true" />
      </div>
    </li>
    <li>
      <div id="trafiken" class="trafiken-sthlm">
        <h3></h3>
        <audio controls autoplay="true" />
      </div>
    </li>
  </ul> -->

  <script src="https://code.jquery.com/jquery-3.1.0.js"></script>
  <script src="js/vendor/moment.js"></script>
  <!-- <script src="js/trafikMeddelanden.js"></script> -->
  <script src="js/vt.js"></script>
  <script src="js/sl.js"></script>
  <script src="js/tv.js"></script>
  <script src="js/resrobot.js"></script>
  <script>
    const positionPromise = getPosition()
      .then(({ coords: { latitude: lat, longitude: long }}) => ({ lat, long }));

    Vue.component('digital-clock', {
      data () {
        return {
          hours: '',
          minutes: '',
          seconds: '',
        }
      },
      created() {
        this.updateDateTime();
        setInterval(this.updateDateTime, 1000);
      },
      methods: {
        updateDateTime () {
          const now = new Date();
          this.hours = String(now.getHours()).padStart(2, "0");
          this.minutes = String(now.getMinutes()).padStart(2, "0");
          this.seconds = String(now.getSeconds()).padStart(2, "0");
        }
      },
      template: `
        <div class="digital-clock">
          {{ hours }}:{{ minutes }}:{{ seconds }}
        </div>
      `
    });

    Vue.component('destination-board', {
      props: {
        trips: Array
      },
      methods: {
        getJurneyDetails(trip) {
          fetch(trip.href)
            .then((resp) => resp.json())
            .then((json) => console.log(json));
        }
      },
      template: `
        <table class="destination-board">
          <thead>
            <tr>
              <th>Till</th>
              <th>Tid</th>
              <th>Linje</th>
              <th>Spår/Läge</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="trip in trips" :key="trip.id" @click.prevent="getJurneyDetails(trip)">
              <td class="trip-dest">{{ trip.direction }}</td>
              <td class="trip-time" :class="{ 'is-late': trip.isLate }">{{ trip.time }}</td>
              <td class="trip-line">{{ trip.name }}</td>
              <td class="trip-track">{{ trip.track }}</td>
            </tr>
          </tbody>
          <tfoot v-show="trips.length === 0">
            <tr>
              <td colspan="4">Inga resor att visa</td>
            </tr>
          </tfoot>
        </div>
      `
    });

    Vue.component('location-input', {
      props: {
        label: String,
        disabled: Boolean,
        parentLoading: Boolean,
        displayNearbyStops: {
          type: Boolean,
          default: false
        },
        locationApi: {
          type: String,
          validator(value) {
            return window[value].hasOwnProperty('findStops') &&
              window[value].hasOwnProperty('getClosestStop') &&
              window[value].hasOwnProperty('getClosestStops') &&
              typeof window[value].findStops === 'function' &&
              typeof window[value].getClosestStop === 'function' &&
              typeof window[value].getClosestStops === 'function';
          }
        }
      },
      data() {
        return {
          show: false,
          isFetching: false,
          fetchingNearbyStops: this.displayNearbyStops,
          searchText: "",
          suggestions: [],
          nearbyStations: []
        };
      },
      computed: {
        isLoading() {
          return this.isFetching || this.parentLoading
        },
        hasSuggestions() {
          return this.suggestions.length || this.nearbyStations.length;
        }
      },
      created() {
        this.debouncedGetSuggestions = debounce(this.getSuggestions, 350, this);
        if (!this.displayNearbyStops) return;
        positionPromise
          .then(window[this.locationApi].getClosestStops)
          .then((stations) => {
          this.nearbyStations = stations;
          this.fetchingNearbyStops = false;
        })
      },
      methods: {
        onInput({ target: { value }}) {
          if (!value) {
            this.suggestions = [];
          } else {
            this.isFetching = true;
            this.debouncedGetSuggestions(value);
          }
        },
        getSuggestions(value) {
          return window[this.locationApi].findStops(value)
            .then((stops) => {
              this.isFetching = false;
              this.suggestions = [].concat(stops);
              this.showDropDown();
            });
          return "hello";
        },
        findNearestStop() {
          this.isFetching = true;
          Promise.resolve(positionPromise)
            .then(window[this.locationApi].getClosestStop)
            .then((location) => {
              if (location) this.onSelect(location);
              this.show = false;
              this.isFetching = false;
              this.isLoading = false;
            });
        },
        onSelect(suggestion) {
          this.searchText = suggestion.name;
          this.$emit('set-location', suggestion);
          this.hideDropDown();
          this.getSuggestions(suggestion.name)
            .then(this.hideDropDown);
        },
        selectFirstSuggestion() {
          if (this.suggestions.length === 0) return;
          this.onSelect(this.suggestions[0]);
        },
        handleKeyInput(e) {
          const dict = {
            ArrowUp: 'previousElementSibling',
            ArrowDown: 'nextElementSibling'
          };

          const getSibling = (el) => el.parentElement[dict[e.key]];

          if (["ArrowDown", "ArrowUp"].includes(e.key) && this.show && this.hasSuggestions) {
            const focused = this.$el.querySelector('.location-input__suggestions a:focus');
            if (!focused) return this.$el.querySelector('.location-input__suggestions a').focus();
            const next = getSibling(focused);
            if (!next) return;
            next.querySelector('a').focus();
          }
        },
        showDropDown() {
          this.show = true;
        },
        hideDropDown() {
          this.show = false;
          document.activeElement.blur();
        },
        possiblyHideDropDown(e) {
          if (e.relatedTarget && this.$el.contains(e.relatedTarget)) return;
          this.hideDropDown();
        }
      },
      template: '#location-input'
    });

    Vue.component('trips-list', {
      props: {
        trips: Array
      },
      template: `
        <ul class="trips">
          <li v-for="trip in trips">
            <trips-item :trip="trip">
          </li>
        </ul>
      `
    });

    Vue.component('trips-item', {
      props: {
        trip: Array
      },
      methods: {
        isLast(index, trip) {
          return index === trip.length - 1;
        }
      },
      template: `
        <ul class="trip">
          <li class="trip__leg" :class="leg.type" v-for="(leg, index) in trip">
            {{ leg.text }} <br/>
            <span class="trip__dest" v-if="isLast(index, trip)">
              ⇥ {{ leg.to.time }}
            </span>
          </li>
        </ul>
      `
    });

    Vue.component('search-trip', {
      template: '#search-trip',
      data() {
        return {
          from: null,
          dest: null,
          isLoading: false,
          trips: [],
          initialized: false
        };
      },
      created() {
        VT.init()
          .then(() => this.initialized = true);
      },
      methods: {
        setFrom(location) {
          this.from = location.id;
        },
        setDest(location) {
          this.dest = location.id;
          if (this.from) this.findTrip();
        },
        findTrip() {
          this.isLoading = true;
          RR.getTripSuggestion(this.from, this.dest)
            .then((trips) => {
              this.trips = trips;
              this.isLoading = false;
            });
        }
      }
    });

    Vue.component('station-info', {
      template: '#station-info',
      data() {
        return {
          from: null,
          isLoading: false,
          initialized: false,
          trips: []
        };
      },
      computed: {
        show() {
          return !!this.trips.length;
        }
      },
      created() {
        VT.init()
          .then(() => this.initialized = true);
      },
      methods: {
        setFrom(location) {
          this.location = location;
          this.trips = [];
          this.isLoading = true;
          this.getDepartures();

          // refresh list every 20 seconds
          this.lastIntervalId && clearInterval(this.lastIntervalId);
          this.lastIntervalId = setInterval(this.getDepartures, 20000);
        },
        getDepartures() {
          window[this.location.region].getDeparturesFrom(this.location.id)
            .then((resp) => {
              this.trips = resp
              this.isLoading = false;
            });
        }
      }
    });

    new Vue({
      el: '#app',
      data: { tab: 1 },
      methods: {
        changeTab(tab) {
          this.tab = tab;
        }
      }
    });

    function debounce(fn, delay, context) {
      var timeoutId;
      context = context || this;
      return (...args) => {
        if (timeoutId) clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn.apply(context, args), delay);
      }
    }

    function getPosition() {
      return new Promise((resolve, reject) => {
        if (!("geolocation" in navigator)) return reject();

        navigator.geolocation.getCurrentPosition(resolve);
      });
    }
  </script>
</body>
</html>
